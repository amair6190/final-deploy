{% extends "base.html" %}
{% load static %}

{% block title %}Create New Ticket{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/create_ticket_theme.css' %}">
{% endblock %}

{% block content %}
<div class="ticket-create-container">
    <div class="ticket-create-card">
        <div class="ticket-create-header">
            <h2><i class="fas fa-ticket-alt me-2"></i> Create a New Support Ticket</h2>
            <p class="subtitle">Please provide details about your issue</p>
        </div>
        <div class="ticket-create-body">
            <form method="post" enctype="multipart/form-data" class="ticket-form">
                {% csrf_token %}
                {% for field in form %}
                    <div class="form-group mb-4">
                        <label for="{{ field.id_for_label }}" class="form-label">
                            {{ field.label }}
                            {% if field.field.required %}
                                <span class="text-danger">*</span>
                            {% endif %}
                        </label>
                        
                        {% if field.name == 'priority' %}
                            <select name="{{ field.name }}" id="{{ field.id_for_label }}" class="form-control" required>
                                {% for value, text in field.field.choices %}
                                    <option value="{{ value }}" {% if field.value == value %}selected{% endif %}>
                                        {{ text }}
                                    </option>
                                {% endfor %}
                            </select>
                        {% elif field.name == 'attachments' %}
                            <div class="file-upload-container">
                                <div class="file-upload-area" id="fileUploadArea">
                                    <input type="file" name="{{ field.name }}" id="{{ field.id_for_label }}" 
                                           class="file-input" multiple 
                                           accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt,.zip,.rar">
                                    <div class="file-upload-content">
                                        <div class="upload-icon-container">
                                            <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                            <div class="upload-progress-ring">
                                                <svg class="progress-ring" width="120" height="120">
                                                    <circle class="progress-ring-circle" stroke="var(--dark-primary)" 
                                                            stroke-width="4" fill="transparent" r="52" cx="60" cy="60"/>
                                                </svg>
                                            </div>
                                        </div>
                                        <h4 class="upload-title">Drag & Drop Files Here</h4>
                                        <p class="upload-subtitle">or <span class="browse-link">click to browse</span></p>
                                        <div class="file-info">
                                            <div class="supported-formats">
                                                <span class="format-badge">PDF</span>
                                                <span class="format-badge">DOC</span>
                                                <span class="format-badge">DOCX</span>
                                                <span class="format-badge">JPG</span>
                                                <span class="format-badge">PNG</span>
                                                <span class="format-badge">TXT</span>
                                                <span class="format-badge">ZIP</span>
                                                <span class="format-badge">RAR</span>
                                            </div>
                                            <small class="size-limit">Maximum size: 5MB per file</small>
                                        </div>
                                    </div>
                                    <div class="upload-success-message" id="uploadSuccess" style="display: none;">
                                        <i class="fas fa-check-circle"></i>
                                        <span>Files ready for upload!</span>
                                    </div>
                                </div>
                                <div class="file-list" id="fileList"></div>
                                <div class="upload-stats" id="uploadStats" style="display: none;">
                                    <div class="stats-item">
                                        <span class="stats-label">Files:</span>
                                        <span class="stats-value" id="fileCount">0</span>
                                    </div>
                                    <div class="stats-item">
                                        <span class="stats-label">Total Size:</span>
                                        <span class="stats-value" id="totalSize">0 B</span>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            {{ field }}
                        {% endif %}
                        
                        {% if field.help_text %}
                            <small class="help-text">{{ field.help_text }}</small>
                        {% endif %}
                        
                        {% if field.errors %}
                            <ul class="errorlist">
                                {% for error in field.errors %}
                                    <li><i class="fas fa-exclamation-circle"></i> {{ error }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                {% endfor %}
                
                <div class="ticket-form-buttons">
                    <button type="submit" class="btn btn-create">
                        <i class="fas fa-paper-plane"></i> Create Ticket
                    </button>
                    <a href="{% url 'tickets:customer_dashboard' %}" class="btn btn-cancel">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('.ticket-form');
    const submitBtn = form.querySelector('.btn-create');
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileInput = document.querySelector('.file-input');
    const fileList = document.getElementById('fileList');
    const browseLink = document.querySelector('.browse-link');

    // Focus first input field
    const firstInput = form.querySelector('input[type="text"], textarea');
    if (firstInput) {
        firstInput.focus();
    }

    // File upload functionality
    if (fileUploadArea && fileInput) {
        let selectedFiles = [];
        let totalSize = 0;
        const uploadSuccess = document.getElementById('uploadSuccess');
        const uploadStats = document.getElementById('uploadStats');
        const fileCount = document.getElementById('fileCount');
        const totalSizeElement = document.getElementById('totalSize');

        // Pulse animation for upload icon
        function pulseUploadIcon() {
            const uploadIcon = document.querySelector('.upload-icon');
            uploadIcon.classList.add('pulse');
            setTimeout(() => uploadIcon.classList.remove('pulse'), 600);
        }

        // Update progress ring
        function updateProgressRing(progress) {
            const circle = document.querySelector('.progress-ring-circle');
            const radius = circle.r.baseVal.value;
            const circumference = radius * 2 * Math.PI;
            const offset = circumference - (progress / 100) * circumference;
            
            circle.style.strokeDasharray = `${circumference} ${circumference}`;
            circle.style.strokeDashoffset = offset;
        }

        // Show upload success message
        function showUploadSuccess() {
            uploadSuccess.style.display = 'flex';
            uploadSuccess.classList.add('success-animation');
            setTimeout(() => {
                uploadSuccess.classList.remove('success-animation');
            }, 1000);
        }

        // Update upload statistics
        function updateUploadStats() {
            fileCount.textContent = selectedFiles.length;
            totalSizeElement.textContent = formatFileSize(totalSize);
            uploadStats.style.display = selectedFiles.length > 0 ? 'flex' : 'none';
        }

        // Enhanced drag and drop handlers
        fileUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('drag-over');
            pulseUploadIcon();
        });

        fileUploadArea.addEventListener('dragenter', function(e) {
            e.preventDefault();
            this.classList.add('drag-active');
        });

        fileUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            if (!this.contains(e.relatedTarget)) {
                this.classList.remove('drag-over', 'drag-active');
            }
        });

        fileUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over', 'drag-active');
            this.classList.add('drop-animation');
            
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
            
            setTimeout(() => {
                this.classList.remove('drop-animation');
            }, 300);
        });

        // Enhanced browse link click
        browseLink.addEventListener('click', function(e) {
            e.preventDefault();
            fileInput.click();
            pulseUploadIcon();
        });

        // Enhanced file input change
        fileInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            handleFiles(files);
        });

        function handleFiles(files) {
            let validFiles = [];
            let progress = 0;
            const progressStep = 100 / files.length;

            files.forEach((file, index) => {
                setTimeout(() => {
                    if (validateFile(file)) {
                        selectedFiles.push(file);
                        totalSize += file.size;
                        validFiles.push(file);
                        displayFile(file);
                    }
                    
                    progress += progressStep;
                    updateProgressRing(progress);
                    
                    if (index === files.length - 1) {
                        setTimeout(() => {
                            updateProgressRing(0);
                            if (validFiles.length > 0) {
                                showUploadSuccess();
                            }
                            updateUploadStats();
                            updateFileInput();
                        }, 200);
                    }
                }, index * 100);
            });
        }

        function validateFile(file) {
            const maxSize = 5 * 1024 * 1024; // 5MB
            const allowedTypes = [
                'application/pdf',
                'application/msword',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'image/jpeg',
                'image/jpg',
                'image/png',
                'text/plain',
                'application/zip',
                'application/x-rar-compressed'
            ];

            if (file.size > maxSize) {
                alert(`File "${file.name}" is too large. Maximum size is 5MB.`);
                return false;
            }

            if (!allowedTypes.includes(file.type) && !isAllowedExtension(file.name)) {
                alert(`File "${file.name}" has an unsupported format.`);
                return false;
            }

            return true;
        }

        function isAllowedExtension(fileName) {
            const allowedExtensions = ['.pdf', '.doc', '.docx', '.jpg', '.jpeg', '.png', '.txt', '.zip', '.rar'];
            const extension = fileName.toLowerCase().substring(fileName.lastIndexOf('.'));
            return allowedExtensions.includes(extension);
        }

        function displayFile(file) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            
            // Get file icon based on file type
            const fileIcon = getFileIcon(file.name);
            const fileSize = formatFileSize(file.size);
            
            fileItem.innerHTML = `
                <div class="file-preview">
                    <div class="file-icon ${getFileTypeClass(file.name)}">
                        <i class="${fileIcon}"></i>
                    </div>
                    <div class="file-upload-progress">
                        <div class="upload-progress-bar">
                            <div class="progress-fill"></div>
                        </div>
                    </div>
                </div>
                <div class="file-details">
                    <div class="file-name" title="${file.name}">${truncateFileName(file.name, 30)}</div>
                    <div class="file-meta">
                        <span class="file-size">${fileSize}</span>
                        <span class="file-type">${getFileExtension(file.name).toUpperCase()}</span>
                    </div>
                </div>
                <div class="file-actions">
                    <button type="button" class="remove-file" data-filename="${file.name}" title="Remove file">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            // Add upload animation
            fileItem.style.opacity = '0';
            fileItem.style.transform = 'translateY(20px)';
            fileList.appendChild(fileItem);
            
            // Animate in
            setTimeout(() => {
                fileItem.style.transition = 'all 0.3s ease';
                fileItem.style.opacity = '1';
                fileItem.style.transform = 'translateY(0)';
                
                // Simulate upload progress
                const progressFill = fileItem.querySelector('.progress-fill');
                setTimeout(() => {
                    progressFill.style.width = '100%';
                    setTimeout(() => {
                        fileItem.querySelector('.file-upload-progress').style.opacity = '0';
                    }, 500);
                }, 100);
            }, 50);

            // Add remove functionality with animation
            fileItem.querySelector('.remove-file').addEventListener('click', function() {
                const filename = this.getAttribute('data-filename');
                const fileIndex = selectedFiles.findIndex(f => f.name === filename);
                
                if (fileIndex > -1) {
                    totalSize -= selectedFiles[fileIndex].size;
                    selectedFiles.splice(fileIndex, 1);
                }
                
                // Animate out
                fileItem.style.transition = 'all 0.3s ease';
                fileItem.style.opacity = '0';
                fileItem.style.transform = 'translateX(-100%)';
                
                setTimeout(() => {
                    fileItem.remove();
                    updateUploadStats();
                    updateFileInput();
                    
                    // Hide success message if no files
                    if (selectedFiles.length === 0) {
                        uploadSuccess.style.display = 'none';
                    }
                }, 300);
            });
        }

        // Helper functions for file handling
        function getFileIcon(filename) {
            const ext = getFileExtension(filename);
            const iconMap = {
                'pdf': 'fas fa-file-pdf',
                'doc': 'fas fa-file-word',
                'docx': 'fas fa-file-word',
                'jpg': 'fas fa-file-image',
                'jpeg': 'fas fa-file-image',
                'png': 'fas fa-file-image',
                'txt': 'fas fa-file-alt',
                'zip': 'fas fa-file-archive',
                'rar': 'fas fa-file-archive'
            };
            return iconMap[ext] || 'fas fa-file';
        }

        function getFileTypeClass(filename) {
            const ext = getFileExtension(filename);
            const classMap = {
                'pdf': 'file-pdf',
                'doc': 'file-doc',
                'docx': 'file-doc',
                'jpg': 'file-image',
                'jpeg': 'file-image',
                'png': 'file-image',
                'txt': 'file-text',
                'zip': 'file-archive',
                'rar': 'file-archive'
            };
            return classMap[ext] || 'file-default';
        }

        function getFileExtension(filename) {
            return filename.toLowerCase().substring(filename.lastIndexOf('.') + 1);
        }

        function truncateFileName(filename, maxLength) {
            if (filename.length <= maxLength) return filename;
            const ext = getFileExtension(filename);
            const nameWithoutExt = filename.substring(0, filename.lastIndexOf('.'));
            const truncated = nameWithoutExt.substring(0, maxLength - ext.length - 4) + '...';
            return truncated + '.' + ext;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateFileInput() {
            const dt = new DataTransfer();
            selectedFiles.forEach(file => dt.items.add(file));
            fileInput.files = dt.files;
        }
    }

    // Add loading state to submit button
    form.addEventListener('submit', function(e) {
        submitBtn.classList.add('loading');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
        submitBtn.disabled = true;
    });

    // Enhance the priority select field
    const prioritySelect = document.querySelector('select[name="priority"]');
    if (prioritySelect) {
        prioritySelect.addEventListener('change', function(e) {
            const value = e.target.value;
            const options = {
                'LOW': '#27ae60',
                'MEDIUM': '#f39c12',
                'HIGH': '#e67e22',
                'URGENT': '#c0392b'
            };
            this.style.color = options[value] || '#2c3e50';
        });
        // Set initial color
        prioritySelect.dispatchEvent(new Event('change'));
    }
});
</script>
{% endblock %}
